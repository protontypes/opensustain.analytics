name: Update OpenSustain Data

on:
  schedule:
    - cron: "0 12 1 * *"  # 12:00 UTC on the first day of each month
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§­ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: âš™ï¸ Install dependencies
        run: |
          python -m pip install --upgrade pip requests

      - name: ğŸ“¥ Download latest OpenSustain release CSVs
        run: |
          python - <<'EOF'
          import os, requests

          repo = "protontypes/open-sustainable-technology"
          api_url = f"https://api.github.com/repos/{repo}/releases/latest"
          headers = {"Accept": "application/vnd.github.v3+json"}

          print("Fetching latest release metadata...")
          release = requests.get(api_url, headers=headers).json()
          tag_name = release.get("tag_name")
          print(f"Latest release: {tag_name}")

          assets = release.get("assets", [])
          os.makedirs("data", exist_ok=True)

          for asset in assets:
              download_url = asset["browser_download_url"]
              name = asset["name"].lower()
              if "project" in name and name.endswith(".csv"):
                  save_name = "data/projects.csv"
              elif "organization" in name and name.endswith(".csv"):
                  save_name = "data/organizations.csv"
              else:
                  continue
              print(f"Downloading {asset['name']} -> {save_name}")
              r = requests.get(download_url)
              with open(save_name, "wb") as f:
                  f.write(r.content)

          print("âœ… CSV files downloaded successfully!")
          EOF

      - name: ğŸ“ Commit & push updated data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add data/projects.csv data/organizations.csv

          if git diff --cached --quiet; then
            echo "No changes detected."
          else
            git commit -m "ğŸ“¦ Update projects.csv and organizations.csv from latest OpenSustain release"
            git push origin HEAD:${GITHUB_REF#refs/heads/}
          fi
